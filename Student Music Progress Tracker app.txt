<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Music Progress Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Custom Fonts: Montserrat for headings, Comfortaa for body -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Comfortaa', sans-serif; /* Comfortaa for body */
            background-color: #fff6eb; /* New Background */
        }
        h1, h2, h3, h4, h5, h6, .font-heading {
            font-family: 'Montserrat', sans-serif; /* Montserrat for headings */
            color: #103a52; /* New Heading/Text Color */
        }
        .container-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .loading-ring {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #103a52; /* Changed to new dark blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for prose content from Markdown */
        .prose {
            font-family: 'Comfortaa', sans-serif; /* Ensure prose uses body font */
            color: #374151; /* gray-700 */
            line-height: 1.65;
        }
        .prose h1, .prose h2, .prose h3 {
            font-family: 'Montserrat', sans-serif; /* Ensure prose headings use heading font */
            color: #103a52; /* New Heading/Text Color */
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose h1 { font-size: 1.875rem; } /* 3xl */
        .prose h2 { font-size: 1.5rem; } /* 2xl */
        .prose h3 { font-size: 1.25rem; } /* xl */
        .prose p {
            margin-top: 1em;
            margin-bottom: 1em;
        }
        .prose ul {
            margin-top: 1em;
            margin-bottom: 1em;
            padding-left: 1.5em;
            list-style-type: disc;
        }
        .prose ol {
            margin-top: 1em;
            margin-bottom: 1em;
            padding-left: 1.5em;
            list-style-type: decimal;
        }
        .prose li {
            margin-top: 0.25em;
        }
    </style>
</head>
<body class="p-4 sm:p-8">


    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold font-heading">Music Student Progress Tracker</h1>
            <p class="text-gray-600 mt-2">Manage student assignments, generate song recommendations, and create 8-week lesson plans instantly.</p>
            <p id="auth-status" class="text-sm mt-1 text-gray-500"></p>
        </header>


        <!-- New Student Form -->
        <section class="container-card p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 font-heading">Add New Student</h2>
            <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-7 gap-4 items-end">
                <input type="text" id="student-name" required placeholder="Student Name" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-[#103a52] focus:border-[#103a52]">
                <input type="number" id="student-age" placeholder="Age" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-[#103a52] focus:border-[#103a52]">
                <input type="text" id="instrument" required placeholder="Instrument" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-[#103a52] focus:border-[#103a52]">
                <select id="skill-level" required class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-[#103a52] focus:border-[#103a52] bg-white">
                    <option value="" disabled selected>Skill Level</option>
                    <option value="Beginner">Beginner</option>
                    <option value="Early Intermediate">Early Intermediate</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Advanced Intermediate">Advanced Intermediate</option>
                    <option value="Advanced">Advanced</option>
                </select>
                <textarea id="current-assignments" rows="1" required placeholder="Current Books & Pieces" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-[#103a52] focus:border-[#103a52] resize-none"></textarea>
                <textarea id="current-goals" rows="1" placeholder="Current Goals (Optional)" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-[#103a52] focus:border-[#103a52] resize-none"></textarea>


                <!-- Changed to new Red color -->
                <button type="submit" class="col-span-1 p-3 bg-[#fc4a4b] text-white font-bold rounded-lg hover:bg-[#e03a3b] transition duration-150 shadow-md">Add Student</button>
            </form>
        </section>


        <!-- XLSX Import Section -->
        <section class="container-card p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 font-heading">Import from .XLSX File</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="file" id="xlsx-file-input" accept=".xlsx" class="flex-grow p-3 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-[#fff6eb] file:text-[#103a52] hover:file:bg-[#fad9b0]">
                <!-- Changed to new Dark Blue color -->
                <button id="import-button" class="p-3 bg-[#103a52] text-white font-bold rounded-lg hover:bg-[#0a283f] transition duration-150 shadow-md">Import Students</button>
            </div>
            <p id="import-status" class="text-sm text-gray-600 mt-2"></p>
        </section>


        <!-- Student List Table -->
        <section class="container-card p-6">
            <h2 class="text-2xl font-semibold mb-4 font-heading">Student Roster</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <!-- Changed header bg and text color -->
                    <thead style="background-color: #fad9b0;">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-[#103a52] uppercase tracking-wider font-heading">Name (User ID)</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-[#103a52] uppercase tracking-wider font-heading">Age</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-[#103a52] uppercase tracking-wider font-heading">Instrument / Level</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-[#103a52] uppercase tracking-wider font-heading">Assignments</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-[#103a52] uppercase tracking-wider font-heading">Goals</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-[#103a52] uppercase tracking-wider font-heading">Lesson Notes</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-[#103a52] uppercase tracking-wider font-heading">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="student-list" class="bg-white divide-y divide-gray-200">
                        <!-- Student rows will be injected here -->
                    </tbody>
                </table>
                <p id="empty-list-message" class="text-center text-gray-500 p-8 hidden">No students added yet. Use the form above to begin tracking!</p>
            </div>
        </section>


    </div>


    <!-- Modal for Generated Content -->
    <div id="content-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="container-card w-full max-w-4xl p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h3 id="modal-title" class="text-2xl font-bold font-heading">Generated Content</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-content" class="prose max-w-none">
                <!-- Content injected here -->
            </div>
            <div id="modal-actions" class="mt-6 text-right">
                <!-- Regenerate button will be injected here -->
            </div>
        </div>
    </div>


    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 bg-red-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="container-card w-full max-w-sm p-6 text-center">
            <h3 class="text-xl font-bold text-red-700 mb-4 font-heading">Error</h3>
            <p id="alert-message" class="text-gray-600 mb-6">An unknown error occurred.</p>
            <button onclick="closeAlert()" class="p-2 w-full bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-150">Close</button>
        </div>
    </div>




    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, setDoc, addDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // Set Firebase Log Level to Debug
        setLogLevel('Debug');


        // --- GLOBAL VARIABLES & FIREBASE INIT ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        let db;
        let auth;
        let userId = 'loading';
        let isAuthReady = false;
        let globalStudentsCache = {}; // Cache for student data


        const API_URL_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; // Placeholder, key provided by runtime


        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);


            // Authentication Setup
            onAuthStateChanged(auth, async (user) => {
                const statusElement = document.getElementById('auth-status');
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    statusElement.textContent = `Authenticated as User ID: ${userId}`;
                    listenForStudents(); // Start listening once authenticated
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        statusElement.textContent = 'Authentication failed. Please check console.';
                        console.error("Firebase Auth Error:", error);
                        isAuthReady = true; 
                    }
                }
            });
        } else {
            console.error("Firebase Config not found. Cannot initialize Firestore.");
            document.getElementById('auth-status').textContent = 'Error: Firebase not configured.';
        }


        // --- UTILITY FUNCTIONS ---


        /** Displays a custom alert modal */
        window.showAlert = function(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-modal').classList.remove('hidden');
            document.getElementById('alert-modal').classList.add('flex');
        }


        /** Closes the custom alert modal */
        window.closeAlert = function() {
            document.getElementById('alert-modal').classList.add('hidden');
            document.getElementById('alert-modal').classList.remove('flex');
        }


        /** Displays the content modal */
        window.showModal = function(title, contentHTML, actionsHTML = '') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = contentHTML;
            document.getElementById('modal-actions').innerHTML = actionsHTML;
            document.getElementById('content-modal').classList.remove('hidden');
            document.getElementById('content-modal').classList.add('flex');
        }


        /** Closes the content modal */
        window.closeModal = function() {
            document.getElementById('content-modal').classList.add('hidden');
            document.getElementById('content-modal').classList.remove('flex');
        }


        /** Safely escapes quotes for inclusion in HTML onclick attributes */
        window.escapeQuotes = function(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/'/g, '&apos;').replace(/"/g, '&quot;');
        }


        // --- FIRESTORE DATA HANDLING ---


        const getStudentsCollectionRef = () => {
            // Public data path: /artifacts/{appId}/public/data/students
            return collection(db, 'artifacts', appId, 'public', 'data', 'students');
        };


        /** Adds a new student to Firestore. */
        document.getElementById('add-student-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!isAuthReady) {
                return showAlert("Authentication is still loading. Please wait a moment.");
            }


            const name = document.getElementById('student-name').value.trim();
            const instrument = document.getElementById('instrument').value.trim();
            const level = document.getElementById('skill-level').value;
            const assignments = document.getElementById('current-assignments').value.trim();
            const goals = document.getElementById('current-goals').value.trim();
            const age = document.getElementById('student-age').value.trim();


            if (!name || !instrument || !level || !assignments) return showAlert("Please fill in all student details (Goals and Age are optional).");


            const studentData = {
                name,
                instrument,
                age: age || null,
                skillLevel: level,
                currentAssignments: assignments,
                currentGoals: goals,
                lessonNoteHistory: "", // Initialize empty
                recommendations: JSON.stringify([]), // Store as empty JSON array string
                lessonPlan: "",
                ownerId: userId,
                timestamp: serverTimestamp()
            };


            try {
                await addDoc(getStudentsCollectionRef(), studentData);
                this.reset();
                document.getElementById('skill-level').value = ""; // Reset select
            } catch (error) {
                console.error("Error adding student:", error);
                showAlert("Failed to add student: " + error.message);
            }
        });


        /** Listens for real-time student updates from Firestore. */
        function listenForStudents() {
            if (!db) return;
            const studentsQuery = query(getStudentsCollectionRef(), orderBy('timestamp', 'desc'));


            onSnapshot(studentsQuery, (snapshot) => {
                const students = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    students.push({ id: doc.id, ...data });
                });
                globalStudentsCache = students.reduce((acc, student) => {
                    acc[student.id] = student;
                    return acc;
                }, {});
                renderStudentList(students);
            }, (error) => {
                console.error("Error listening to students:", error);
                showAlert("Failed to load students in real-time: " + error.message);
            });
        }


        /** Renders the list of students in the table. */
        function renderStudentList(students) {
            const list = document.getElementById('student-list');
            list.innerHTML = '';
            document.getElementById('empty-list-message').classList.toggle('hidden', students.length > 0);


            students.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.id = `student-row-${student.id}`;
                
                const recs = JSON.parse(student.recommendations || '[]');
                
                // Using arbitrary values for the specific hex codes
                row.innerHTML = `
                    <!-- Display Mode -->
                    <td id="name-display-${student.id}" class="px-3 py-4 whitespace-nowrap text-sm font-medium text-[#103a52]">${student.name}<br><span class="text-xs text-gray-500">${student.ownerId}</span></td>
                    <td id="age-display-${student.id}" class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${student.age || 'N/A'}</td>
                    <td id="instrument-display-${student.id}" class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${student.instrument} / ${student.skillLevel}</td>
                    <td id="assignments-display-${student.id}" class="px-3 py-4 text-sm text-gray-500 max-w-xs whitespace-pre-wrap">${student.currentAssignments}</td>
                    <td id="goals-display-${student.id}" class="px-3 py-4 text-sm text-gray-500 max-w-xs whitespace-pre-wrap">${student.currentGoals}</td>
                    <td id="history-display-${student.id}" class="px-3 py-4 text-sm text-gray-500 max-w-xs whitespace-pre-wrap">${student.lessonNoteHistory}</td>


                    <!-- Edit Mode (hidden by default) -->
                    <td id="name-edit-${student.id}" class="px-3 py-4 hidden"><input type="text" value="${escapeQuotes(student.name)}" class="w-full p-2 border rounded-lg"></td>
                    <td id="age-edit-${student.id}" class="px-3 py-4 hidden"><input type="number" value="${student.age || ''}" class="w-20 p-2 border rounded-lg"></td>
                    <td id="instrument-edit-${student.id}" class="px-3 py-4 hidden">
                        <input type="text" value="${escapeQuotes(student.instrument)}" class="w-full p-2 border rounded-lg mb-2">
                        <select class="w-full p-2 border rounded-lg bg-white">
                            <option value="Beginner" ${student.skillLevel === 'Beginner' ? 'selected' : ''}>Beginner</option>
                            <option value="Early Intermediate" ${student.skillLevel === 'Early Intermediate' ? 'selected' : ''}>Early Intermediate</option>
                            <option value="Intermediate" ${student.skillLevel === 'Intermediate' ? 'selected' : ''}>Intermediate</option>
                            <option value="Advanced Intermediate" ${student.skillLevel === 'Advanced Intermediate' ? 'selected' : ''}>Advanced Intermediate</option>
                            <option value="Advanced" ${student.skillLevel === 'Advanced' ? 'selected' : ''}>Advanced</option>
                        </select>
                    </td>
                    <td id="assignments-edit-${student.id}" class="px-3 py-4 hidden"><textarea rows="3" class="w-full p-2 border rounded-lg">${escapeQuotes(student.currentAssignments)}</textarea></td>
                    <td id="goals-edit-${student.id}" class="px-3 py-4 hidden"><textarea rows="3" class="w-full p-2 border rounded-lg">${escapeQuotes(student.currentGoals)}</textarea></td>
                    <td id="history-edit-${student.id}" class="px-3 py-4 hidden"><textarea rows="3" class="w-full p-2 border rounded-lg">${escapeQuotes(student.lessonNoteHistory)}</textarea></td>


                    <!-- Action Buttons - Display Mode (New Palette) -->
                    <td id="actions-${student.id}" class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex flex-col space-y-2">
                            <button onclick="window.editStudent('${student.id}')" class="w-full text-xs p-2 rounded-lg bg-[#103a52] text-white hover:bg-[#0a283f] transition">Edit</button>
                            <button onclick="window.handleRecsClick('${student.id}')"
                                class="w-full text-xs p-2 rounded-lg bg-[#fad9b0] text-[#103a52] hover:bg-[#f8c68c] transition">
                                ${recs.length > 0 ? 'View/Regen Recs' : 'Generate Recs'}
                            </button>
                            <button onclick="window.handlePlanClick('${student.id}')"
                                class="w-full text-xs p-2 rounded-lg bg-[#fc4a4b] text-white hover:bg-[#e03a3b] transition">
                                ${student.lessonPlan ? 'View/Regen Plan' : 'Generate Plan'}
                            </button>
                            <button onclick="window.generateAndShowJourneyReport('${student.id}')"
                                class="w-full text-xs p-2 rounded-lg bg-[#103a52] text-white hover:bg-[#0a283f] transition">
                                ✨ Draft Journey Report
                            </button>
                        </div>
                    </td>
                    <!-- Action Buttons - Edit Mode (New Palette) -->
                    <td id="actions-edit-${student.id}" class="px-3 py-4 whitespace-nowrap text-sm font-medium hidden">
                        <div class="flex flex-col space-y-2">
                            <button onclick="window.saveStudent('${student.id}')" class="w-full text-xs p-2 rounded-lg bg-[#fc4a4b] text-white hover:bg-[#e03a3b] transition">Save</button>
                            <button onclick="window.cancelEdit('${student.id}')" class="w-full text-xs p-2 rounded-lg bg-[#64748b] text-white hover:bg-[#586477] transition">Cancel</button>
                        </div>
                    </td>
                `;
                list.appendChild(row);
            });
        }
        
        // --- IN-LINE EDITING ---


        window.editStudent = function(studentId) {
            // Hide display fields
            document.getElementById(`name-display-${studentId}`).classList.add('hidden');
            document.getElementById(`age-display-${studentId}`).classList.add('hidden');
            document.getElementById(`instrument-display-${studentId}`).classList.add('hidden');
            document.getElementById(`assignments-display-${studentId}`).classList.add('hidden');
            document.getElementById(`goals-display-${studentId}`).classList.add('hidden');
            document.getElementById(`history-display-${studentId}`).classList.add('hidden');
            document.getElementById(`actions-${studentId}`).classList.add('hidden');
            
            // Show edit fields
            document.getElementById(`name-edit-${studentId}`).classList.remove('hidden');
            document.getElementById(`age-edit-${studentId}`).classList.remove('hidden');
            document.getElementById(`instrument-edit-${studentId}`).classList.remove('hidden');
            document.getElementById(`assignments-edit-${studentId}`).classList.remove('hidden');
            document.getElementById(`goals-edit-${studentId}`).classList.remove('hidden');
            document.getElementById(`history-edit-${studentId}`).classList.remove('hidden');
            document.getElementById(`actions-edit-${studentId}`).classList.remove('hidden');
        }


        window.cancelEdit = function(studentId) {
            // Show display fields
            document.getElementById(`name-display-${studentId}`).classList.remove('hidden');
            document.getElementById(`age-display-${studentId}`).classList.remove('hidden');
            document.getElementById(`instrument-display-${studentId}`).classList.remove('hidden');
            document.getElementById(`assignments-display-${studentId}`).classList.remove('hidden');
            document.getElementById(`goals-display-${studentId}`).classList.remove('hidden');
            document.getElementById(`history-display-${studentId}`).classList.remove('hidden');
            document.getElementById(`actions-${studentId}`).classList.remove('hidden');
            
            // Hide edit fields
            document.getElementById(`name-edit-${studentId}`).classList.add('hidden');
            document.getElementById(`age-edit-${studentId}`).classList.add('hidden');
            document.getElementById(`instrument-edit-${studentId}`).classList.add('hidden');
            document.getElementById(`assignments-edit-${studentId}`).classList.add('hidden');
            document.getElementById(`goals-edit-${studentId}`).classList.add('hidden');
            document.getElementById(`history-edit-${studentId}`).classList.add('hidden');
            document.getElementById(`actions-edit-${studentId}`).classList.add('hidden');
        }


        window.saveStudent = async function(studentId) {
            const name = document.querySelector(`#name-edit-${studentId} input`).value.trim();
            const age = document.querySelector(`#age-edit-${studentId} input`).value.trim();
            const instrument = document.querySelector(`#instrument-edit-${studentId} input`).value.trim();
            const skillLevel = document.querySelector(`#instrument-edit-${studentId} select`).value;
            const assignments = document.querySelector(`#assignments-edit-${studentId} textarea`).value.trim();
            const goals = document.querySelector(`#goals-edit-${studentId} textarea`).value.trim();
            const history = document.querySelector(`#history-edit-${studentId} textarea`).value.trim();
            
            if (!name || !instrument || !skillLevel || !assignments) {
                return showAlert("Name, Instrument, Skill Level, and Assignments are required.");
            }
            
            const updatedData = {
                name,
                age: age || null,
                instrument,
                skillLevel,
                currentAssignments: assignments,
                currentGoals: goals,
                lessonNoteHistory: history
            };
            
            try {
                const studentRef = doc(getStudentsCollectionRef(), studentId);
                await setDoc(studentRef, updatedData, { merge: true });
                cancelEdit(studentId); // Switch back to display mode
            } catch (error) {
                console.error("Error saving student:", error);
                showAlert("Failed to save student: " + error.message);
            }
        }




        // --- XLSX IMPORT ---
        document.getElementById('import-button').addEventListener('click', function() {
            const fileInput = document.getElementById('xlsx-file-input');
            const file = fileInput.files[0];
            const statusEl = document.getElementById('import-status');
            
            if (!file) {
                return showAlert("Please select an .xlsx file first.");
            }


            statusEl.textContent = "Importing, please wait...";
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);


                    if (json.length === 0) {
                        statusEl.textContent = "File is empty or could not be read.";
                        return;
                    }


                    const importedStudents = json.map(row => {
                        const name = `${row['First Name'] || ''} ${row['Last Name'] || ''}`.trim();
                        // FIX: Combine Book, Page, and Pieces from correct column headers
                        const assignments = `${row['Book'] || 'N/A'} (p. ${row['Current book page'] || 'N/A'})\nPieces: ${row['Current Pieces'] || 'N/A'}`.trim();
                        
                        return {
                            name: name || "Unnamed Student",
                            instrument: row['Instrument'] || 'Unknown',
                            age: row['Age'] || null,
                            // FIX: Use 'Skill Level' header
                            skillLevel: mapSkillLevel(row['Skill Level']),
                            // FIX: Use corrected assignments variable
                            currentAssignments: assignments,
                            // FIX: Use 'Goals' header
                            currentGoals: row['Goals'] || '',
                            // FIX: Set to blank as requested
                            lessonNoteHistory: "", 
                            recommendations: JSON.stringify([]),
                            lessonPlan: "",
                            ownerId: userId,
                            timestamp: serverTimestamp()
                        };
                    });


                    let successCount = 0;
                    for (const studentData of importedStudents) {
                        await addDoc(getStudentsCollectionRef(), studentData);
                        successCount++;
                    }
                    
                    statusEl.textContent = `Successfully imported ${successCount} of ${importedStudents.length} students.`;
                    fileInput.value = ''; // Clear file input
                } catch (error) {
                    console.error("Error importing file:", error);
                    statusEl.textContent = "Error importing file: " + error.message;
                    showAlert("Error processing file. Check console for details.");
                }
            };
            
            reader.readAsArrayBuffer(file);
        });


        /** Maps 4-level rubric to 5-level system */
        function mapSkillLevel(level) {
            if (!level) return 'Intermediate'; // Default fallback if cell is empty
            const levelStr = String(level).toLowerCase();
            if (levelStr.includes('1') || levelStr.includes('beginner')) return 'Beginner';
            if (levelStr.includes('2')) return 'Early Intermediate';
            if (levelStr.includes('3')) return 'Intermediate';
            if (levelStr.includes('4') || levelStr.includes('advanced')) return 'Advanced';
            return 'Intermediate'; // Default fallback
        }




        // --- GEMINI API INTEGRATION ---


        /**
         * Generic function to call the Gemini API with exponential backoff.
         * @param {object} payload - The request body for the generateContent API.
         * @param {string} endpoint - The model endpoint to use.
         * @param {boolean} useGrounding - Whether to enable Google Search grounding.
         * @returns {Promise<object>} The parsed API response JSON.
         */
        async function callGeminiApi(payload, endpoint, useGrounding = false) {
            const apiUrl = `${API_URL_BASE}${endpoint}:generateContent?key=${API_KEY}`;
            const maxRetries = 5;
            
            // Create a copy of the payload to add grounding if needed
            const finalPayload = { ...payload };
            if (useGrounding) {
                finalPayload.tools = [{ "google_search": {} }];
            }


            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(finalPayload) // Use the potentially modified payload
                    });


                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        const errorBody = await response.json();
                        throw new Error(`API Error ${response.status}: ${errorBody.error.message}`);
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) throw error;
                }
            }
        }
        
        /** Handles clicking the "Recs" button (View vs Generate) */
        window.handleRecsClick = function(studentId) {
            const student = globalStudentsCache[studentId];
            if (!student) return showAlert("Student data not found.");
            
            const recommendations = JSON.parse(student.recommendations || '[]');
            
            if (recommendations.length > 0) {
                // View existing
                const tableHTML = formatRecommendationsToHTML(recommendations);
                const actionsHTML = `<button onclick="window.generateAndShowRecommendations('${student.id}', true)" class="p-2 bg-[#fad9b0] text-[#103a52] font-bold rounded-lg hover:bg-[#f8c68c] transition">Regenerate</button>`;
                showModal(`${student.name} - Song Recommendations`, tableHTML, actionsHTML);
            } else {
                // Generate new
                window.generateAndShowRecommendations(student.id, false);
            }
        }
        
        /** Handles clicking the "Plan" button (View vs Generate) */
        window.handlePlanClick = function(studentId) {
            const student = globalStudentsCache[studentId];
            if (!student) return showAlert("Student data not found.");
            
            if (student.lessonPlan) {
                // View existing
                const planHTML = convertMarkdownToHTML(student.lessonPlan);
                const actionsHTML = `<button onclick="window.generateAndShowLessonPlan('${student.id}', true)" class="p-2 bg-[#fc4a4b] text-white font-bold rounded-lg hover:bg-[#e03a3b] transition">Regenerate</button>`;
                showModal(`${student.name} - 8-Week Lesson Plan`, planHTML, actionsHTML);
            } else {
                // Generate new
                window.generateAndShowLessonPlan(student.id, false);
            }
        }


        /**
         * Generates song recommendations using the LLM and updates Firestore.
         */
        window.generateAndShowRecommendations = async function(studentId, isRegenerating = false) {
            if (!isAuthReady) {
                return showAlert("Authentication is still loading. Please wait a moment.");
            }
            
            const student = globalStudentsCache[studentId];
            if (!student) return showAlert("Student data not found.");


            // Show loading state
            const loadingHTML = '<div class="flex justify-center items-center h-32"><div class="loading-ring"></div><p class="ml-4 text-[#103a52]">Searching for recommendations...</p></div>';
            showModal('Generating...', loadingHTML, '');
            
            const systemPrompt = `You are a music teacher assistant. Generate a list of 5 pieces appropriate for the specified instrument, skill level, and student goals.
            
            Your entire response MUST be a single, valid JSON array string (e.g., [ { "title": "...", ... } ]).
            Do not include any text, markdown, or apologies before or after the JSON array.
            
            Each object in the array must have these keys: "title", "composer", "focus".`;
            
            const userQuery = `Generate song recommendations for a ${student.instrument} student at the ${student.skillLevel} level.
            Student Goals: ${student.currentGoals || 'Not specified'}
            Student Lesson History: ${student.lessonNoteHistory || 'Not specified'}`;


            // --- THIS IS THE KEY CHANGE ---
            // We remove the rigid 'generationConfig' with the JSON schema
            // and will parse the text response from the AI instead.
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                // NO generationConfig forcing JSON schema
            };


            try {
                // Call the API with grounding disabled (false)
                const result = await callGeminiApi(payload, MODEL_NAME, false);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;


                if (!jsonText) {
                    throw new Error("AI returned an empty response. Please try again.");
                }


                let parsedRecs;
                try {
                    // We parse the text response, assuming the AI followed instructions
                    parsedRecs = JSON.parse(jsonText);
                } catch (parseError) {
                    console.error("JSON Parse Error:", parseError);
                    console.error("Received text from AI:", jsonText);
                    throw new Error("AI returned data in an invalid format. The AI's response could not be understood.");
                }


                if (!Array.isArray(parsedRecs) || parsedRecs.length === 0) {
                    throw new Error("AI returned an empty or invalid recommendations list.");
                }


                const recsJSONString = JSON.stringify(parsedRecs);


                // Update Firestore
                const studentRef = doc(getStudentsCollectionRef(), studentId);
                await setDoc(studentRef, { recommendations: recsJSONString }, { merge: true });


                // Display the results
                const tableHTML = formatRecommendationsToHTML(parsedRecs);
                const actionsHTML = `<button onclick="window.generateAndShowRecommendations('${student.id}', true)" class="p-2 bg-[#fad9b0] text-[#103a52] font-bold rounded-lg hover:bg-[#f8c68c] transition">Regenerate</button>`;
                showModal(`${student.name} - Song Recommendations`, tableHTML, actionsHTML);


            } catch (error) {
                console.error("Recommendation Generation Error:", error);
                closeModal();
                // Provide a more user-friendly error message for this specific failure
                if (error.message.includes("The string did not match") || error.message.includes("invalid format")) {
                     showAlert(`Failed to generate recommendations: The AI's response was in an invalid format. Please try again.`);
                } else {
                    showAlert(`Failed to generate recommendations: ${error.message}`);
                }
            }
        }


        /** Formats the recommendations array into an HTML table. */
        function formatRecommendationsToHTML(recommendations) {
            let html = `
                <p class="mb-4 text-gray-600">The following pieces were generated based on the student's instrument, skill level, and goals.</p>
                <table class="min-w-full divide-y divide-gray-200 shadow-lg rounded-lg overflow-hidden">
                    <thead style="background-color: #fad9b0;">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-[#103a52] uppercase tracking-wider font-heading">Piece</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-[#103a52] uppercase tracking-wider font-heading">Composer</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-[#103a52] uppercase tracking-wider font-heading">Technical Focus</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
            `;


            recommendations.forEach(rec => {
                html += `
                    <tr>
                        <td class="px-4 py-3 whitespace-normal text-sm font-medium text-[#103a52]">${rec.title}</td>
                        <td class="px-4 py-3 whitespace-normal text-sm text-gray-700">${rec.composer}</td>
                        <td class="px-4 py-3 whitespace-normal text-sm text-gray-700">${rec.focus}</td>
                    </tr>
                `;
            });


            html += `</tbody></table>`;
            return html;
        }


        /**
         * Generates an 8-week lesson plan using the LLM and updates Firestore.
         */
        window.generateAndShowLessonPlan = async function(studentId, isRegenerating = false) {
            if (!isAuthReady) {
                return showAlert("Authentication is still loading. Please wait a moment.");
            }
            
            const student = globalStudentsCache[studentId];
            if (!student) return showAlert("Student data not found.");


            // Show loading state
            const loadingHTML = `<div class="flex justify-center items-center h-32"><div class="loading-ring"></div><p class="ml-4 text-[#103a52]">Creating 8-week lesson plan...</p></div>`;
            showModal('Generating...', loadingHTML, '');


            const systemPrompt = `You are an expert music educator. Create a structured 8-week lesson plan tailored to the student's instrument, materials, goals, and history. The plan should balance technical exercises, sight-reading, and repertoire.
            Format the response in clean Markdown. Use headings (e.g., '### Week 1-2: Focus on Technique') and bullet points for clarity. 
            Ensure new information starts on a new line. Do not use horizontal rules (---) or asterisks for bullets; use dashes (-) instead.`;
            
            const userQuery = `Create an 8-week plan for this ${student.instrument} student.
            Current Materials: ${student.currentAssignments}
            Student Goals: ${student.currentGoals || 'Not specified'}
            Lesson Note History: ${student.lessonNoteHistory || 'Not specified'}`;


            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };


            try {
                // Note: No grounding (useGrounding = false) for this call.
                const result = await callGeminiApi(payload, MODEL_NAME, false); 
                const planText = result.candidates?.[0]?.content?.parts?.[0]?.text;


                if (!planText) throw new Error("Could not parse text response.");


                // Update Firestore
                const studentRef = doc(getStudentsCollectionRef(), studentId);
                await setDoc(studentRef, { lessonPlan: planText }, { merge: true });


                // Display the results
                const planHTML = convertMarkdownToHTML(planText);
                const actionsHTML = `<button onclick="window.generateAndShowLessonPlan('${student.id}', true)" class="p-2 bg-[#fc4a4b] text-white font-bold rounded-lg hover:bg-[#e03a3b] transition">Regenerate</button>`;
                showModal(`${student.name} - 8-Week Lesson Plan`, planHTML, actionsHTML);


            } catch (error) {
                console.error("Lesson Plan Generation Error:", error);
                closeModal();
                showAlert(`Failed to generate lesson plan: ${error.message}. Please try again.`);
            }
        }
        
        /**
         * Generates a parent note using the LLM.
         */
        window.generateAndShowJourneyReport = async function(studentId) {
            if (!isAuthReady) {
                return showAlert("Authentication is still loading. Please wait a moment.");
            }
            
            const student = globalStudentsCache[studentId];
            if (!student) return showAlert("Student data not found.");
            
            showModal('Generating...', '<div class="flex justify-center items-center h-32"><div class="loading-ring"></div><p class="ml-4 text-[#103a52]">Drafting Musician\'s Journey Report...</p></div>', '');


            const age = parseInt(student.age, 10);
            const isAdult = age && age > 18;
            
            let systemPrompt = '';


            if (isAdult) {
                systemPrompt = `You are an expert music educator drafting an encouraging "Musician's Journey Report" for an adult student.
                The tone should be positive, professional, and collaborative.
                The report must cover:
                1.  **Student's Progress:** Summarize their progress based on lesson history.
                2.  **Achievements:** Highlight key pieces mastered or skills developed.
                3.  **Goal Achievement:** How they have successfully (or are in the process of) achieving their stated goals.
                4.  **Looking Forward:** A brief look at what skills and concepts you plan to cover next.
                Format this as a clean document. Use headings (###) and bullet points (-) for clarity.`;
            } else {
                systemPrompt = `You are an expert music educator drafting an encouraging "Musician's Journey Report" for the parent of a student.
                **CRITICAL: Assume the parent has ZERO musical knowledge.**
                The tone must be positive, professional, and simple.
                The report must cover:
                1.  **Student's Progress:** Summarize their progress. (e.g., "improved rhythm" becomes "got much better at playing steady beats").
                2.  **Achievements:** Highlight key pieces mastered.
                3.  **Goal Achievement:** How they are achieving their goals.
                4.  **Looking Forward:** A brief, simple look at what's next (e.g., "We'll start learning how to play with both hands together more often.").
                Format this as a clean document. Use headings (###) and bullet points (-) for clarity.`;
            }
            
            const userQuery = `Draft the Musician's Journey Report for ${student.name} (${student.instrument}).
            Student's Age: ${student.age || 'Not specified'}
            Current Materials: ${student.currentAssignments}
            Stated Goals: ${student.currentGoals || 'Not specified'}
            Lesson Note History: ${student.lessonNoteHistory || 'Not specified'}`;


            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };


            try {
                // Note: No grounding (useGround_ing = false) for this call.
                const result = await callGeminiApi(payload, MODEL_NAME, false);
                const noteText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!noteText) throw new Error("Could not parse text response.");


                const noteHTML = convertMarkdownToHTML(noteText);
                showModal(`${student.name} - Journey Report`, noteHTML, '');


            } catch (error) {
                console.error("Journey Report Generation Error:", error);
                closeModal();
                showAlert(`Failed to generate journey report: ${error.message}. Please try again.`);
            }
        }


        /**
         * Converts a Markdown string to clean HTML for the modal.
         */
        function convertMarkdownToHTML(md) {
            let html = md;


            // 1. Headings (e.g., ### Heading)
            html = html.replace(/^### (.*$)/gim, '<h3 class="font-bold text-lg mb-2 mt-4">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 class="font-bold text-xl mb-2 mt-5">$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1 class="font-bold text-2xl mb-2 mt-6">$1</h1>');


            // 2. Bold (e.g., **text**)
            html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/gim, '<strong>$1</strong>');


            // 3. Italics (e.g., *text*)
            html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');
            html = html.replace(/_(.*?)_/gim, '<em>$1</em>');


            // 4. Lists (e.g., - item or * item or 1. item)
            // Handle unordered lists
            html = html.replace(/^[ \t]*[\*\-] (.*$)/gim, '<li>$1</li>');
            html = html.replace(/<\/li>\n<li>/gim, '</li><li>'); // Join adjacent list items
            html = html.replace(/^(<li>.*<\/li>)$/gim, '<ul>$1</ul>'); // Wrap single-line lists
            // Wrap multi-line lists
            html = html.replace(/(<ul>(<li>.*<\/li>)+<\/ul>)/gim, '$1'); // Avoid double-wrapping
            html = html.replace(/(<li>.*<\/li>)/gim, '<ul>$1</ul>'); // Wrap orphan items (basic)
            
            // Handle ordered lists
            html = html.replace(/^[ \t]*[0-9]+\. (.*$)/gim, '<li>$1</li>');
            html = html.replace(/<\/li>\n<li>/gim, '</li><li>'); // Join adjacent list items
            html = html.replace(/^(<li>.*<\/li>)$/gim, '<ol>$1</ol>'); // Wrap single-line lists
            // Wrap multi-line lists
            html = html.replace(/(<ol>(<li>.*<\/li>)+<\/ol>)/gim, '$1'); // Avoid double-wrapping
            html = html.replace(/(<li>.*<\/li>)/gim, '<ol>$1</ol>'); // Wrap orphan items (basic)
            
            // Fix adjacent lists by merging them
            html = html.replace(/<\/ul>\n<ul>/gim, '');
            html = html.replace(/<\/ol>\n<ol>/gim, '');
            
            // 5. Paragraphs (split by newlines)
            html = html.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => {
                    if (line.startsWith('<h') || line.startsWith('<ul') || line.startsWith('<ol') || line.startsWith('<li>') || line.endsWith('</ul>') || line.endsWith('</ol>')) {
                        return line; // Don't wrap headings or lists in <p>
                    }
                    return `<p>${line}</p>`;
                })
                .join('');
            
            // Clean up empty paragraphs that might result
            html = html.replace(/<p><\/p>/gim, '');
            // Clean up list items wrapped in paragraphs
            html = html.replace(/<p><li>/gim, '<li>');
            html = html.replace(/<\/li><\/p>/gim, '</li>');


            return html;
        }


    </script>
</body>
</html>